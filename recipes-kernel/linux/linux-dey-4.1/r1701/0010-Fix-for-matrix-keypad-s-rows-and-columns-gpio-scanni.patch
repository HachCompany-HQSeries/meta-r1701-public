From 7550c95aaf574c270411ab6087b8574d090af711 Mon Sep 17 00:00:00 2001
From: Devang Patel <dpatel@hach.com>
Date: Thu, 18 Jan 2018 10:22:44 -0700
Subject: [PATCH 10/10] Fix for matrix keypad's rows and columns gpio scanning
 issue.

---
 drivers/input/keyboard/matrix_keypad.c | 18 +++++++++++++-----
 1 file changed, 13 insertions(+), 5 deletions(-)

diff --git a/drivers/input/keyboard/matrix_keypad.c b/drivers/input/keyboard/matrix_keypad.c
index b370a59..0bb6d69 100644
--- a/drivers/input/keyboard/matrix_keypad.c
+++ b/drivers/input/keyboard/matrix_keypad.c
@@ -52,10 +52,14 @@ static void __activate_col(const struct matrix_keypad_platform_data *pdata,
 	bool level_on = !pdata->active_low;
 
 	if (on) {
-		gpio_direction_output(pdata->col_gpios[col], level_on);
+		/* Scan sleep API is not changing GPIO lines as expected.       */
+		/* hence we are using standard GPIO set API.                    */
+		/* gpio_direction_output(pdata->col_gpios[col], level_on);      */
+		gpio_set_value(pdata->col_gpios[col], level_on);
 	} else {
-		gpio_set_value_cansleep(pdata->col_gpios[col], !level_on);
-		gpio_direction_input(pdata->col_gpios[col]);
+		/* gpio_set_value_cansleep(pdata->col_gpios[col], !level_on);	*/
+		/* gpio_direction_input(pdata->col_gpios[col]); */
+		gpio_set_value(pdata->col_gpios[col], !level_on);
 	}
 }
 
@@ -80,8 +84,12 @@ static void activate_all_cols(const struct matrix_keypad_platform_data *pdata,
 static bool row_asserted(const struct matrix_keypad_platform_data *pdata,
 			 int row)
 {
-	return gpio_get_value_cansleep(pdata->row_gpios[row]) ?
-			!pdata->active_low : pdata->active_low;
+	/* Scan sleep API is not changing GPIO lines as expected.       */
+	/* hence we are using standard GPIO set API.                    */
+	/* return gpio_get_value_cansleep(pdata->row_gpios[row]) ?	*/
+	/*		!pdata->active_low : pdata->active_low;		*/
+	return gpio_get_value(pdata->row_gpios[row]) ?
+		!pdata->active_low : pdata->active_low;
 }
 
 static void enable_row_irqs(struct matrix_keypad *keypad)
-- 
2.7.4

