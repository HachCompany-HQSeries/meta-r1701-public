From e4bd7ed3635648ed9a773eca07650129c470075b Mon Sep 17 00:00:00 2001
From: Devang Patel <dpatel@hach.com>
Date: Wed, 7 Feb 2018 08:51:33 -0700
Subject: [PATCH 2/2] Changed code to support r1701 rev 1 hardware.

---
 board/digi/r1701/r1701.c | 72 ++++++++++++++++++++++--------------------------
 1 file changed, 33 insertions(+), 39 deletions(-)

diff --git a/board/digi/r1701/r1701.c b/board/digi/r1701/r1701.c
index 3d58ea2856..10e3b5dd1c 100644
--- a/board/digi/r1701/r1701.c
+++ b/board/digi/r1701/r1701.c
@@ -102,13 +102,13 @@ static iomux_v3_cfg_t const ext_gpios_pads[] = {
 #endif
 
 /* micro SD */
-static iomux_v3_cfg_t const usdhc2_pads[] = {
-	MX6_PAD_CSI_VSYNC__USDHC2_CLK | MUX_PAD_CTRL(USDHC_PAD_CTRL),
-	MX6_PAD_CSI_HSYNC__USDHC2_CMD | MUX_PAD_CTRL(USDHC_PAD_CTRL),
-	MX6_PAD_CSI_DATA00__USDHC2_DATA0 | MUX_PAD_CTRL(USDHC_PAD_CTRL),
-	MX6_PAD_CSI_DATA01__USDHC2_DATA1 | MUX_PAD_CTRL(USDHC_PAD_CTRL),
-	MX6_PAD_CSI_DATA02__USDHC2_DATA2 | MUX_PAD_CTRL(USDHC_PAD_CTRL),
-	MX6_PAD_CSI_DATA03__USDHC2_DATA3 | MUX_PAD_CTRL(USDHC_PAD_CTRL),
+static iomux_v3_cfg_t const usdhc1_pads[] = {
+	MX6_PAD_SD1_CLK__USDHC1_CLK     | MUX_PAD_CTRL(USDHC_PAD_CTRL),
+	MX6_PAD_SD1_CMD__USDHC1_CMD     | MUX_PAD_CTRL(USDHC_PAD_CTRL),
+	MX6_PAD_SD1_DATA0__USDHC1_DATA0 | MUX_PAD_CTRL(USDHC_PAD_CTRL),
+	MX6_PAD_SD1_DATA1__USDHC1_DATA1 | MUX_PAD_CTRL(USDHC_PAD_CTRL),
+	MX6_PAD_SD1_DATA2__USDHC1_DATA2 | MUX_PAD_CTRL(USDHC_PAD_CTRL),
+	MX6_PAD_SD1_DATA3__USDHC1_DATA3 | MUX_PAD_CTRL(USDHC_PAD_CTRL),
 };
 
 #ifdef CONFIG_SYS_I2C_MXC
@@ -145,10 +145,13 @@ static iomux_v3_cfg_t const fec1_pads[] = {
 	MX6_PAD_ENET1_RX_ER__ENET1_RX_ER | MUX_PAD_CTRL(ENET_PAD_CTRL),
 	MX6_PAD_ENET1_RX_EN__ENET1_RX_EN | MUX_PAD_CTRL(ENET_PAD_CTRL),
 	/*
-	 * GPIO3_IO2 is used as PHY reset in Starter Board v1 and as PHY power
-	 * enable on Starter Board v2
+	 * GPIO3_IO23 is used as PHY reset in r1701 v1 board.
 	 */
-	MX6_PAD_LCD_HSYNC__GPIO3_IO02 | MUX_PAD_CTRL(NO_PAD_CTRL),
+	MX6_PAD_LCD_DATA18__GPIO3_IO23 | MUX_PAD_CTRL(NO_PAD_CTRL),
+	/*
+     * GPIO3_IO22 is used as power enable control pin for entire Ethernet module.
+     */
+    MX6_PAD_LCD_DATA17__GPIO3_IO22 | MUX_PAD_CTRL(NO_PAD_CTRL),
 };
 
 static void setup_iomux_fec(void)
@@ -164,7 +167,7 @@ static void setup_iomux_uart(void)
 
 #ifdef CONFIG_FSL_ESDHC
 static struct fsl_esdhc_cfg usdhc_cfg[] = {
-	{USDHC2_BASE_ADDR, 0, 4},
+	{USDHC1_BASE_ADDR, 0, 4},
 };
 
 int mmc_get_env_devno(void)
@@ -207,8 +210,8 @@ int board_mmc_init(bd_t *bis)
 		switch (i) {
 		case 0:
 			imx_iomux_v3_setup_multiple_pads(
-				usdhc2_pads, ARRAY_SIZE(usdhc2_pads));
-			usdhc_cfg[0].sdhc_clk = mxc_get_clock(MXC_ESDHC2_CLK);
+				usdhc1_pads, ARRAY_SIZE(usdhc1_pads));
+			usdhc_cfg[0].sdhc_clk = mxc_get_clock(MXC_ESDHC_CLK);
 			break;
 		default:
 			printf("Warning: you configured more USDHC controllers"
@@ -234,27 +237,18 @@ void reset_phy()
 	 * be deasserted before 25ms have passed since the power supply has
 	 * reached 80% of the operating voltage. At this point of the code
 	 * we can assume the second premise is already accomplished.
+     *
+     * r1701 - v1 Board - MX6_PAD_LCD_DATA18__GPIO3_IO23 --> ENET1_RST Pin
+     *
 	 */
-	if (board_version == 1) {
-		int phy_reset_gpio = IMX_GPIO_NR(3, 2);
-
-		/* Assert PHY reset (low) */
-		gpio_direction_output(phy_reset_gpio , 0);
-		udelay(100);
-		/* Deassert PHY reset (high) */
-		gpio_set_value(phy_reset_gpio, 1);
-	} else {
-		/* MCA_IO7 is connected to PHY reset */
-		int reset = (1 << 7);
-
-		/* Configure as output */
-		mca_update_bits(MCA_CC6UL_GPIO_DIR_0, reset, reset);
-		/* Assert PHY reset (low) */
-		mca_update_bits(MCA_CC6UL_GPIO_DATA_0, reset, 0);
-		udelay(100);
-		/* Deassert PHY reset (high) */
-		mca_update_bits(MCA_CC6UL_GPIO_DATA_0, reset, reset);
-	}
+    int phy_reset_gpio = IMX_GPIO_NR(3, 23);
+
+    /* Assert PHY reset (low) */
+    gpio_direction_output(phy_reset_gpio , 0);
+    udelay(100);
+
+    /* Deassert PHY reset (high) */
+    gpio_set_value(phy_reset_gpio, 1);
 }
 
 int board_eth_init(bd_t *bis)
@@ -279,12 +273,12 @@ static int setup_fec(int fec_id)
 		= (struct iomuxc_gpr_base_regs *) IOMUXC_GPR_BASE_ADDR;
 	int ret;
 
-	if (board_version != 1) {
-		/* Enable PHY power */
-		int phy_power_gpio = IMX_GPIO_NR(3, 2);
-
-		gpio_direction_output(phy_power_gpio , 1);
-	}
+    /*
+     * r1701 - v1 - ENET1_PWR* - MX6_PAD_LCD_DATA17__GPIO3_IO22, Active Low Signal.
+     */
+    /* Enable PHY power */
+    int phy_power_gpio = IMX_GPIO_NR(3, 22);
+    gpio_direction_output(phy_power_gpio , 0);
 
 	if (0 == fec_id) {
 		if (check_module_fused(MX6_MODULE_ENET1))
-- 
2.11.0

